# ============================================
# Summary SaaS Application
# Ù…Ø¹ Traefik Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Nginx
# ============================================

services:
  # ============================================
  # PostgreSQL Database
  # ============================================
  db:
    image: postgres:16
    container_name: summary_postgres
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      POSTGRES_DB: "${DB_NAME}"
      POSTGRES_USER: "${DB_USER}"
      POSTGRES_PASSWORD: "${DB_PASSWORD}"
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - app-network
      - web # ğŸ†• Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Traefik
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================
  # Django Backend
  # ============================================
  backend:
    build:
      context: ./back-end
      dockerfile: Dockerfile
    container_name: summary_backend
    restart: unless-stopped
    env_file:
      - ./back-end/.env
    volumes:
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    expose:
      - "8000"
    networks:
      - app-network
      - web # ğŸ†• Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Traefik
    depends_on:
      db:
        condition: service_healthy

    labels:
      # ØªÙØ¹ÙŠÙ„ Traefik
      - "traefik.enable=true"
      # ===== API Routes =====
      # Backend API Ø¹Ù„Ù‰: https://summary.osmbeta.cloud/api/
      - "traefik.http.routers.summary-api.rule=Host(`summary.osmbeta.cloud`) && PathPrefix(`/api`)"
      - "traefik.http.routers.summary-api.entrypoints=websecure"
      - "traefik.http.routers.summary-api.tls.certresolver=letsencrypt"
      - "traefik.http.routers.summary-api.service=summary-api"
      - "traefik.http.services.summary-api.loadbalancer.server.port=8000"

      # ===== Admin Routes =====
      # Django Admin Ø¹Ù„Ù‰: https://summary.osmbeta.cloud/admin/
      - "traefik.http.routers.summary-admin.rule=Host(`summary.osmbeta.cloud`) && PathPrefix(`/admin`)"
      - "traefik.http.routers.summary-admin.entrypoints=websecure"
      - "traefik.http.routers.summary-admin.tls.certresolver=letsencrypt"
      - "traefik.http.routers.summary-admin.service=summary-api"

      # ===== Static Files =====
      # Static files Ø¹Ù„Ù‰: https://summary.osmbeta.cloud/static/
      - "traefik.http.routers.summary-static.rule=Host(`summary.osmbeta.cloud`) && PathPrefix(`/static`)"
      - "traefik.http.routers.summary-static.entrypoints=websecure"
      - "traefik.http.routers.summary-static.tls.certresolver=letsencrypt"
      - "traefik.http.routers.summary-static.service=summary-api"
      # ===== Media Files =====
      # Media files Ø¹Ù„Ù‰: https://summary.osmbeta.cloud/media/
      - "traefik.http.routers.summary-media.rule=Host(`summary.osmbeta.cloud`) && PathPrefix(`/media`)"
      - "traefik.http.routers.summary-media.entrypoints=websecure"
      - "traefik.http.routers.summary-media.tls.certresolver=letsencrypt"
      - "traefik.http.routers.summary-media.service=summary-api"

      # ===== Middlewares =====
      # ØªØ·Ø¨ÙŠÙ‚ Ø£Ù…Ø§Ù† Ùˆ rate limiting
      - "**traefik.http.routers.summary-api.middlewares=api-security-headers,api-rate-limit,compression,cors-headers**" # ğŸ’¡ Ø¥Ø¶Ø§ÙØ© cors-headers
      - "traefik.http.routers.summary-admin.middlewares=security-headers,auth-rate-limit"
      - "**traefik.http.routers.summary-static.middlewares=security-headers,compression**" # ğŸ’¡ ØªØ¹Ø¯ÙŠÙ„ Ù„Ù€ Static
      - "**traefik.http.routers.summary-media.middlewares=security-headers,compression**" # ğŸ’¡ ØªØ¹Ø¯ÙŠÙ„ Ù„Ù€ Media
  # ============================================
  # React/Vite Frontend
  # ============================================
  frontend:
    build:
      context: ./front-end
      dockerfile: Dockerfile
    container_name: summary_frontend
    restart: unless-stopped
    expose:
      - "80"
    networks:
      - web # ğŸ†• Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Traefik
    labels:
      # ØªÙØ¹ÙŠÙ„ Traefik
      - "traefik.enable=true"

      # ===== Frontend Routes =====
      # Frontend Ø¹Ù„Ù‰: https://summary.osmbeta.cloud/
      - "traefik.http.routers.summary-frontend.rule=Host(`summary.osmbeta.cloud`)"
      - "traefik.http.routers.summary-frontend.entrypoints=websecure"
      - "traefik.http.routers.summary-frontend.tls.certresolver=letsencrypt"
      - "traefik.http.routers.summary-frontend.service=summary-frontend"
      - "traefik.http.services.summary-frontend.loadbalancer.server.port=80"

      # ===== Wildcard Ù„Ù„Ù€ Multi-tenant =====
      # Tenants Ø¹Ù„Ù‰: https://*.osmbeta.cloud/
      - "traefik.http.routers.summary-tenants.rule=HostRegexp(`^[a-z0-9-]+\\.osmbeta\\.cloud$`)"
      - "traefik.http.routers.summary-tenants.entrypoints=websecure"
      - "traefik.http.routers.summary-tenants.tls.certresolver=letsencrypt"
      - "traefik.http.routers.summary-tenants.service=summary-frontend"

      # ===== Middlewares =====
      - "traefik.http.routers.summary-frontend.middlewares=security-headers,rate-limit,compression"
      - "traefik.http.routers.summary-tenants.middlewares=security-headers,rate-limit,compression"

      # ===== Priority =====
      # Backend routes Ù„Ù‡Ø§ Ø£ÙˆÙ„ÙˆÙŠØ© Ø£Ø¹Ù„Ù‰ Ù…Ù† Frontend
      - "traefik.http.routers.summary-api.priority=100"
      - "traefik.http.routers.summary-admin.priority=100"
      - "traefik.http.routers.summary-static.priority=100"
      - "traefik.http.routers.summary-media.priority=100"
      - "traefik.http.routers.summary-frontend.priority=1"

volumes:
  postgres_data:
    name: summary_postgres_data
  static_volume:
    name: summary_static
  media_volume:
    name: summary_media

networks:
  # Ø´Ø¨ÙƒØ© Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ù„ØªÙˆØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„Ø®Ø¯Ù…Ø§Øª
  app-network:
    name: summary_network
    driver: bridge

  # Ø´Ø¨ÙƒØ© Ø®Ø§Ø±Ø¬ÙŠØ© Ù„Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Traefik
  web:
    external: true
    name: web
